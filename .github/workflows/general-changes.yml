name: General Changes Pipeline

on:
  push:
    branches: [main]
    paths-ignore:
      - 'control-plane/**'
      - 'media-server/**'
      - 'frontend/**'
      - '.github/workflows/control-plane.yml'
      - '.github/workflows/media-server.yml'
      - '.github/workflows/frontend.yml'
  pull_request:
    branches: [main]
    paths-ignore:
      - 'control-plane/**'
      - 'media-server/**'
      - 'frontend/**'
      - '.github/workflows/control-plane.yml'
      - '.github/workflows/media-server.yml'
      - '.github/workflows/frontend.yml'

jobs:
  general-checks:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate repository structure
        run: |
          echo "ðŸ” Checking repository structure..."

          # Check if all main directories exist
          for dir in control-plane media-server frontend docs; do
            if [ -d "$dir" ]; then
              echo "âœ… $dir directory found"
            else
              echo "âŒ $dir directory missing"
              exit 1
            fi
          done

          # Check if workflow files exist
          for workflow in control-plane media-server frontend general-changes deploy health-check; do
            if [ -f ".github/workflows/${workflow}.yml" ]; then
              echo "âœ… ${workflow}.yml workflow found"
            else
              echo "âš ï¸  ${workflow}.yml workflow not found"
            fi
          done

      - name: Check documentation
        run: |
          echo "ðŸ“š Checking documentation files..."

          # Check for main documentation files
          doc_files=("README.md" "DEPLOYMENT_GUIDE.md" "SETUP_GUIDE.md" "DEPLOYMENT.md")
          for file in "${doc_files[@]}"; do
            if [ -f "$file" ]; then
              echo "âœ… $file found"
            else
              echo "âš ï¸  $file not found"
            fi
          done

      - name: Validate workflow syntax
        run: |
          echo "ðŸ”§ Validating GitHub Actions workflow syntax..."

          # Install actionlint for YAML validation
          if ! command -v actionlint > /dev/null 2>&1; then
            echo "Installing actionlint..."
            bash <(curl https://raw.githubusercontent.com/rhymond/actionlint/main/scripts/download-actionlint.bash)
            sudo mv actionlint /usr/local/bin/
          fi

          # Run actionlint on all workflow files
          actionlint .github/workflows/*.yml || echo "Some workflows may have warnings"

      - name: Security checks
        run: |
          echo "ðŸ”’ Running basic security checks..."

          # Check for potential secrets in files
          if command -v grep > /dev/null 2>&1; then
            echo "Checking for potential hardcoded secrets..."
            grep -r -i "password\|secret\|key\|token" --include="*.js" --include="*.json" --include="*.yml" . | grep -v node_modules | grep -v ".git" | head -10 || echo "No obvious secrets found"
          fi

          echo "âœ… General checks completed!"
