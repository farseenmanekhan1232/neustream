name: Enhanced Health Check

on:
  schedule:
    - cron: "0 */6 * * *" # Every 6 hours
  workflow_dispatch: # Manual trigger

jobs:
  comprehensive-health-check:
    runs-on: ubuntu-latest
    steps:
      - name: Check Control Plane Health
        run: |
          echo "üîç Checking Control Plane health..."
          response=$(curl -s --max-time 10 -o /dev/null -w "%{http_code}" https://api.neustream.app/health || echo "failed")
          if [ "$response" = "200" ]; then
            echo "‚úÖ Control Plane health endpoint is healthy"
          else
            echo "‚ùå Control Plane health endpoint failed (HTTP $response)"
            exit 1
          fi

      - name: Check Multi-Source API Endpoints
        run: |
          echo "üîç Checking multi-source API endpoints..."

          # Test sources endpoint (should return 401 when not authenticated)
          sources_response=$(curl -s --max-time 10 -o /dev/null -w "%{http_code}" https://api.neustream.app/api/sources || echo "failed")
          if [ "$sources_response" = "401" ]; then
            echo "‚úÖ Sources API endpoint is properly protected"
          else
            echo "‚ö†Ô∏è Sources API endpoint returned unexpected status: $sources_response"
          fi

          # Test streams info endpoint (should return 401 when not authenticated)
          streams_response=$(curl -s --max-time 10 -o /dev/null -w "%{http_code}" "https://api.neustream.app/api/streams/info" || echo "failed")
          if [ "$streams_response" = "401" ]; then
            echo "‚úÖ Streams API endpoint is properly protected"
          else
            echo "‚ö†Ô∏è Streams API endpoint returned unexpected status: $streams_response"
          fi

          # Test forwarding endpoint with invalid key (should return 404)
          forwarding_response=$(curl -s --max-time 10 -o /dev/null -w "%{http_code}" "https://api.neustream.app/api/streams/forwarding/invalid-key" || echo "failed")
          if [ "$forwarding_response" = "404" ]; then
            echo "‚úÖ Forwarding API endpoint is working correctly"
          else
            echo "‚ö†Ô∏è Forwarding API endpoint returned unexpected status: $forwarding_response"
          fi

      - name: Check Media Server and RTMP Port
        run: |
          echo "üîç Checking Media Server health..."

          # Check media server web interface
          web_response=$(curl -s --max-time 10 -o /dev/null -w "%{http_code}" https://stream.neustream.app/ || echo "failed")
          if [ "$web_response" = "200" ]; then
            echo "‚úÖ Media Server web interface is healthy"
          else
            echo "‚ùå Media Server web interface failed (HTTP $web_response)"
            exit 1
          fi

          # Check RTMP port accessibility (using a simple connection test)
          echo "üîç Checking RTMP port accessibility..."
          if timeout 5 bash -c "</dev/tcp/stream.neustream.app/1935" 2>/dev/null; then
            echo "‚úÖ RTMP port 1935 is accessible"
          else
            echo "‚ö†Ô∏è RTMP port 1935 test failed (this might be normal if no active streams)"
          fi

      - name: Check Frontend Availability
        run: |
          echo "üîç Checking Frontend availability..."
          frontend_response=$(curl -s --max-time 10 -o /dev/null -w "%{http_code}" https://www.neustream.app/ || echo "failed")
          if [ "$frontend_response" = "200" ]; then
            echo "‚úÖ Frontend is healthy"
          else
            echo "‚ùå Frontend is down (HTTP $frontend_response)"
            exit 1
          fi

      - name: Check Admin Panel Availability
        run: |
          echo "üîç Checking Admin Panel availability..."
          admin_response=$(curl -s --max-time 10 -o /dev/null -w "%{http_code}" https://neustream-admin.pages.dev/ || echo "failed")
          if [ "$admin_response" = "200" ]; then
            echo "‚úÖ Admin Panel is healthy"
          else
            echo "‚ö†Ô∏è Admin Panel returned unexpected status (HTTP $admin_response)"
          fi

      - name: Database Connectivity Check
        run: |
          echo "üîç Checking database connectivity (indirect)..."
          # Since we can't directly access the database, we'll test an endpoint that requires database access
          db_test_response=$(curl -s --max-time 10 -o /dev/null -w "%{http_code}" "https://api.neustream.app/api/auth/stream" || echo "failed")
          if [ "$db_test_response" = "401" ] || [ "$db_test_response" = "400" ]; then
            echo "‚úÖ Database appears to be accessible (API endpoint responding)"
          else
            echo "‚ö†Ô∏è Database connectivity check inconclusive (HTTP $db_test_response)"
          fi

      - name: SSL Certificate Check
        run: |
          echo "üîç Checking SSL certificates..."

          # Check control plane SSL
          if echo | openssl s_client -connect api.neustream.app:443 -servername api.neustream.app 2>/dev/null | openssl x509 -noout -dates 2>/dev/null; then
            echo "‚úÖ Control Plane SSL certificate is valid"
          else
            echo "‚ùå Control Plane SSL certificate issue detected"
          fi

          # Check media server SSL
          if echo | openssl s_client -connect stream.neustream.app:443 -servername stream.neustream.app 2>/dev/null | openssl x509 -noout -dates 2>/dev/null; then
            echo "‚úÖ Media Server SSL certificate is valid"
          else
            echo "‚ùå Media Server SSL certificate issue detected"
          fi

          # Check frontend SSL
          if echo | openssl s_client -connect www.neustream.app:443 -servername www.neustream.app 2>/dev/null | openssl x509 -noout -dates 2>/dev/null; then
            echo "‚úÖ Frontend SSL certificate is valid"
          else
            echo "‚ùå Frontend SSL certificate issue detected"
          fi

      - name: Performance Check
        run: |
          echo "üîç Checking response times..."

          # Test control plane response time
          control_plane_time=$(curl -o /dev/null -s -w "%{time_total}" --max-time 10 https://api.neustream.app/health || echo "0")
          if (( $(echo "$control_plane_time < 2.0" | bc -l) )); then
            echo "‚úÖ Control Plane response time: ${control_plane_time}s (good)"
          else
            echo "‚ö†Ô∏è Control Plane response time: ${control_plane_time}s (slow)"
          fi

          # Test frontend response time
          frontend_time=$(curl -o /dev/null -s -w "%{time_total}" --max-time 10 https://www.neustream.app/ || echo "0")
          if (( $(echo "$frontend_time < 3.0" | bc -l) )); then
            echo "‚úÖ Frontend response time: ${frontend_time}s (good)"
          else
            echo "‚ö†Ô∏è Frontend response time: ${frontend_time}s (slow)"
          fi

      - name: Summary Report
        run: |
          echo ""
          echo "üéâ NeuStream Multi-Source Health Check Summary"
          echo "=================================================="
          echo "‚úÖ Core Services: Control Plane, Media Server, Frontend"
          echo "‚úÖ Multi-Source API: Sources, Streams, Forwarding endpoints"
          echo "‚úÖ Admin Panel: Platform management interface"
          echo "‚úÖ SSL Certificates: All domains have valid certificates"
          echo "‚úÖ Performance: Response times within acceptable ranges"
          echo ""
          echo "üöÄ Next scheduled check: $(date -d '+6 hours' '+%Y-%m-%d %H:%M:%S UTC')"
          echo "üìä All systems operational!"
