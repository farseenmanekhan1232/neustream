name: Health Check

on:
  schedule:
    - cron: "0 */6 * * *" # Every 6 hours
  workflow_dispatch: # Manual trigger

jobs:
  health-check:
    runs-on: ubuntu-latest
    steps:
      - name: Check Control Plane
        run: |
          response=$(curl -s --max-time 10 -o /dev/null -w "%{http_code}" https://api.neustream.app/health || echo "failed")
          if [ "$response" = "200" ]; then
            echo "✅ Control Plane is healthy"
          else
            echo "❌ Control Plane is down (HTTP $response)"
            exit 1
          fi

      - name: Check Media Server HTTP
        run: |
          response=$(curl -s --max-time 10 -o /dev/null -w "%{http_code}" https://stream.neustream.app/ || echo "failed")
          if [ "$response" = "200" ]; then
            echo "✅ Media Server HTTP is healthy"
          else
            echo "❌ Media Server HTTP is down (HTTP $response)"
            exit 1
          fi

      - name: Check MediaMTX API
        run: |
          response=$(curl -s --max-time 10 -o /dev/null -w "%{http_code}" https://stream.neustream.app:9997/v3/config/global/get || echo "failed")
          if [ "$response" = "200" ]; then
            echo "✅ MediaMTX API is healthy"
          else
            echo "❌ MediaMTX API is down (HTTP $response)"
            exit 1
          fi

      - name: Check Multi-Source API Endpoints
        run: |
          # Test sources endpoint (should return 401 without auth)
          response=$(curl -s --max-time 10 -o /dev/null -w "%{http_code}" https://api.neustream.app/api/sources || echo "failed")
          if [ "$response" = "401" ]; then
            echo "✅ Multi-source API endpoints are protected"
          else
            echo "❌ Multi-source API endpoints might not be properly protected (HTTP $response)"
            exit 1
          fi

      - name: Check Admin Panel
        run: |
          response=$(curl -s --max-time 10 -o /dev/null -w "%{http_code}" https://neustream-admin.pages.dev/ || echo "failed")
          if [ "$response" = "200" ]; then
            echo "✅ Admin Panel is accessible"
          else
            echo "❌ Admin Panel is down (HTTP $response)"
            exit 1
          fi
