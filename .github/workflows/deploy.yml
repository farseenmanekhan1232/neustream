name: Deploy Neustream (Initial Setup)

on:
  workflow_dispatch:  # Manual trigger only

jobs:
  setup-control-plane:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Copy code to Control Plane
      uses: appleboy/scp-action@v0.1.3
      with:
        host: ${{ secrets.CONTROL_PLANE_HOST }}
        username: ${{ secrets.CONTROL_PLANE_USERNAME }}
        key: ${{ secrets.CONTROL_PLANE_SSH_KEY }}
        source: "."
        target: "/opt/neustream"

    - name: Setup Control Plane
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.CONTROL_PLANE_HOST }}
        username: ${{ secrets.CONTROL_PLANE_USERNAME }}
        key: ${{ secrets.CONTROL_PLANE_SSH_KEY }}
        script: |
          echo "ðŸš€ Running complete Control Plane setup..."

          # Update package list
          sudo apt update

          # Install git
          sudo apt install -y git

          # Install Node.js 18
          curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
          sudo apt install -y nodejs

          # Install PM2
          sudo npm install -g pm2

          # Create app directory and set ownership
          sudo mkdir -p /opt/neustream
          sudo chown ${{ secrets.CONTROL_PLANE_USERNAME }}:${{ secrets.CONTROL_PLANE_USERNAME }} /opt/neustream
          cd /opt/neustream

          # Install dependencies
          npm install --no-audit --no-fund

          # Create environment file
          cat > .env << EOF
          DB_HOST=${{ secrets.DB_HOST }}
          DB_PORT=${{ secrets.DB_PORT }}
          DB_NAME=${{ secrets.DB_NAME }}
          DB_USER=${{ secrets.DB_USER }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          PORT=3000
          NODE_ENV=production
          MEDIA_SERVER_HOST=${{ secrets.MEDIA_SERVER_HOST }}
          JWT_SECRET=$(openssl rand -base64 32)
          EOF

          # Try to run migrations (might fail if DB not accessible)
          npm run migrate || echo "Migrations failed - will retry later"

          # Start service with PM2
          pm2 start server.js --name "neustream-control-plane"
          pm2 save

          # Setup PM2 startup
          sudo env PATH=$PATH:/usr/bin /usr/lib/node_modules/pm2/bin/pm2 startup systemd -u ${{ secrets.CONTROL_PLANE_USERNAME }} --hp /home/${{ secrets.CONTROL_PLANE_USERNAME }}

          echo "âœ… Control Plane setup complete!"

  setup-media-server:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Copy code to Media Server
      uses: appleboy/scp-action@v0.1.3
      with:
        host: ${{ secrets.MEDIA_SERVER_HOST }}
        username: ${{ secrets.MEDIA_SERVER_USERNAME }}
        key: ${{ secrets.MEDIA_SERVER_SSH_KEY }}
        source: "."
        target: "/opt/neustream"

    - name: Setup Media Server
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.MEDIA_SERVER_HOST }}
        username: ${{ secrets.MEDIA_SERVER_USERNAME }}
        key: ${{ secrets.MEDIA_SERVER_SSH_KEY }}
        script: |
          echo "ðŸš€ Running complete Media Server setup..."

          # Update package list
          sudo apt update

          # Install git
          sudo apt install -y git

          # Install nginx with RTMP module
          sudo apt install -y nginx libnginx-mod-rtmp

          # Configure firewall (use iptables instead of ufw)
          sudo iptables -A INPUT -p tcp --dport 1935 -j ACCEPT
          sudo iptables -A INPUT -p tcp --dport 80 -j ACCEPT

          # Create app directory and set ownership
          sudo mkdir -p /opt/neustream
          sudo chown ${{ secrets.MEDIA_SERVER_USERNAME }}:${{ secrets.MEDIA_SERVER_USERNAME }} /opt/neustream
          cd /opt/neustream

          # Configure nginx with control plane IP
          sed -i "s/CONTROL_PLANE_IP_HERE/${{ secrets.CONTROL_PLANE_HOST }}/g" nginx-rtmp.conf

          # Remove problematic RTMP directives for Ubuntu nginx
          sed -i '/rtmp_auto_push on;/d' nginx-rtmp.conf
          sed -i '/rtmp_auto_push_reconnect 1s;/d' nginx-rtmp.conf

          # Deploy nginx configuration
          sudo cp nginx-rtmp.conf /etc/nginx/nginx.conf
          sudo nginx -t
          sudo systemctl restart nginx
          sudo systemctl enable nginx

          echo "âœ… Media Server setup complete!"

  deploy-frontend:
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request'
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install Vercel CLI
      run: npm install -g vercel

    - name: Deploy to Vercel
      run: |
        if [ -n "${{ secrets.VERCEL_TOKEN }}" ]; then
          cd frontend
          echo "VITE_API_BASE=http://${{ secrets.CONTROL_PLANE_HOST }}:3000/api" > .env.production
          vercel --prod --token ${{ secrets.VERCEL_TOKEN }} --confirm
        else
          echo "Skipping Vercel deployment - VERCEL_TOKEN not set"
        fi