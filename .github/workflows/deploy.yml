name: Deploy Neustream (Initial Setup)

on:
  workflow_dispatch: # Manual trigger only

jobs:
  setup-control-plane:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Copy code to Control Plane
        uses: appleboy/scp-action@v0.1.3
        with:
          host: ${{ secrets.CONTROL_PLANE_HOST }}
          username: ${{ secrets.CONTROL_PLANE_USERNAME }}
          key: ${{ secrets.CONTROL_PLANE_SSH_KEY }}
          source: "control-plane/"
          target: "/opt/neustream"

      - name: Setup Control Plane
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.CONTROL_PLANE_HOST }}
          username: ${{ secrets.CONTROL_PLANE_USERNAME }}
          key: ${{ secrets.CONTROL_PLANE_SSH_KEY }}
          script: |
            echo "üöÄ Running complete Control Plane setup..."

            # Update package list
            sudo apt update

            # Install git (skip if already installed)
            sudo apt install -y git || echo "Git already installed"

            # Enable IPv6 for database connectivity
            echo 'net.ipv6.conf.all.disable_ipv6 = 0' | sudo tee -a /etc/sysctl.conf
            echo 'net.ipv6.conf.default.disable_ipv6 = 0' | sudo tee -a /etc/sysctl.conf
            sudo sysctl -p

            # Install and configure local PostgreSQL database
            echo "üöÄ Setting up local PostgreSQL database..."
            sudo apt install -y postgresql postgresql-contrib

            # Start PostgreSQL service
            sudo systemctl start postgresql
            sudo systemctl enable postgresql

            # Drop existing database and user (if they exist) and create fresh ones
            sudo -u postgres psql -c "DROP DATABASE IF EXISTS neustream;"
            sudo -u postgres psql -c "DROP USER IF EXISTS neustream_user;"
            sudo -u postgres psql -c "CREATE DATABASE neustream;"
            sudo -u postgres psql -c "CREATE USER neustream_user WITH PASSWORD '23k4j123k4ksdhfasiuhe';"
            sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE neustream TO neustream_user;"

            # Allow local connections
            echo "host    neustream     neustream_user     127.0.0.1/32            md5" | sudo tee -a /etc/postgresql/*/main/pg_hba.conf

            # Restart PostgreSQL to apply changes
            sudo systemctl restart postgresql

            echo "‚úÖ Local PostgreSQL database installed and configured"

            # Install Node.js 18 (skip if already installed)
            if ! command -v node &> /dev/null; then
              curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
              sudo apt install -y nodejs
            else
              echo "Node.js already installed"
            fi

            # Install PM2 (skip if already installed)
            sudo npm install -g pm2 || echo "PM2 already installed"

            # No Cloudflare Tunnel needed - using Hostinger domain with SSL

            # Install nginx for HTTPS reverse proxy
            sudo apt install -y nginx

            # Open firewall ports for HTTP/HTTPS (Oracle Cloud)
            sudo iptables -A INPUT -p tcp --dport 80 -j ACCEPT 2>/dev/null || echo "Port 80 rule already exists"
            sudo iptables -A INPUT -p tcp --dport 443 -j ACCEPT 2>/dev/null || echo "Port 443 rule already exists"

            # Create app directory and set ownership (idempotent)
            sudo mkdir -p /opt/neustream
            sudo chown ${{ secrets.CONTROL_PLANE_USERNAME }}:${{ secrets.CONTROL_PLANE_USERNAME }} /opt/neustream
            cd /opt/neustream

            # Install dependencies
            npm install --no-audit --no-fund

            # Create environment file with local PostgreSQL configuration
            cat > .env << EOF
            NODE_ENV=production
            POSTHOG_API_KEY=${{ secrets.POSTHOG_API_KEY }}
            POSTHOG_HOST=${{ secrets.POSTHOG_HOST }}
            STREAM_DOMAIN=${{ secrets.STREAM_DOMAIN }}
            SESSION_SECRET=${{ secrets.SESSION_SECRET }}
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            FRONTEND_URL=${{ secrets.FRONTEND_URL }}
            GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
            GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}
            GOOGLE_CALLBACK_URL=${{ secrets.GOOGLE_CALLBACK_URL }}
            TWITCH_CLIENT_ID=${{ secrets.TWITCH_CLIENT_ID }}
            TWITCH_CLIENT_SECRET=${{ secrets.TWITCH_CLIENT_SECRET }}
            TWITCH_CALLBACK_URL=${{ secrets.TWITCH_CALLBACK_URL }}

            CORS_ORIGINS=${{ secrets.CORS_ORIGINS }}
            FRONTEND_URL=https://neustream.app
            DB_HOST=localhost
            DB_PORT=5432
            DB_NAME=neustream
            DB_USER=neustream_user
            DB_PASSWORD=23k4j123k4ksdhfasiuhe
            PORT=3000
            NODE_ENV=production
            MEDIA_SERVER_HOST=${{ secrets.MEDIA_SERVER_HOST }}
            EOF

            # Copy nginx configuration from project
            sudo cp /opt/neustream/nginx-control-plane.conf /etc/nginx/sites-available/neustream
            sudo ln -sf /etc/nginx/sites-available/neustream /etc/nginx/sites-enabled/
            sudo rm -f /etc/nginx/sites-enabled/default
            sudo nginx -t
            sudo systemctl restart nginx

            # Run database migrations with local PostgreSQL
            echo "Running database migrations..."

            # Try multi-source migration first, fallback to legacy
            if node scripts/migrate-multi-source.js; then
              echo "‚úÖ Multi-source database migration completed successfully"
            else
              echo "‚ùå Multi-source migration failed - checking if script exists..."
              if [ -f scripts/migrate-multi-source.js ]; then
                echo "Migration script exists but failed - rolling back..."
                exit 1
              else
                echo "‚ö†Ô∏è Migration script not found - running legacy migration instead..."
                if node scripts/migrate.js; then
                  echo "‚úÖ Legacy migration completed"
                else
                  echo "‚ùå Legacy migration also failed"
                  exit 1
                fi
              fi
            fi

            # Stop existing service if running
            pm2 delete neustream-control-plane 2>/dev/null || echo "No existing service to delete"

            # Clean up any orphaned processes
            pkill -f "node.*server.js" 2>/dev/null || echo "No orphaned processes found"

            # Start service with PM2
            pm2 start server.js --name "neustream-control-plane"
            pm2 save

            # Setup PM2 startup (idempotent)
            sudo env PATH=$PATH:/usr/bin /usr/lib/node_modules/pm2/bin/pm2 startup systemd -u ${{ secrets.CONTROL_PLANE_USERNAME }} --hp /home/${{ secrets.CONTROL_PLANE_USERNAME }} 2>/dev/null || echo "PM2 startup already configured"

            # Verify service is running
            sleep 5
            pm2 status
            curl -f http://localhost:3000/health || echo "Health check failed but continuing..."
            curl -f "http://localhost:3000/api/streams/info?userId=1" || echo "Streams info endpoint failed but continuing..."

            echo "‚úÖ Control Plane setup complete!"

  setup-media-server:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Copy code to Media Server
        uses: appleboy/scp-action@v0.1.3
        with:
          host: ${{ secrets.MEDIA_SERVER_HOST }}
          username: ${{ secrets.MEDIA_SERVER_USERNAME }}
          key: ${{ secrets.MEDIA_SERVER_SSH_KEY }}
          source: "media-server/"
          target: "/opt/neustream"

      - name: Setup Media Server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.MEDIA_SERVER_HOST }}
          username: ${{ secrets.MEDIA_SERVER_USERNAME }}
          key: ${{ secrets.MEDIA_SERVER_SSH_KEY }}
          script: |
            echo "üöÄ Running complete Media Server setup..."

            # Update package list
            sudo apt update

            # Install git (skip if already installed)
            sudo apt install -y git || echo "Git already installed"

            # Install Node.js 18 (skip if already installed)
            if ! command -v node &> /dev/null; then
              curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
              sudo apt install -y nodejs
            else
              echo "Node.js already installed"
            fi

            # Install PM2 (skip if already installed)
            sudo npm install -g pm2 || echo "PM2 already installed"

            # Install nginx for HTTPS reverse proxy (without RTMP module)
            sudo apt install -y nginx

            # Configure firewall (use iptables instead of ufw)
            sudo iptables -A INPUT -p tcp --dport 1935 -j ACCEPT 2>/dev/null || echo "Firewall rule already exists"
            sudo iptables -A INPUT -p tcp --dport 80 -j ACCEPT 2>/dev/null || echo "Firewall rule already exists"
            sudo iptables -A INPUT -p tcp --dport 443 -j ACCEPT 2>/dev/null || echo "Firewall rule already exists"

            # Create app directory and set ownership (idempotent)
            sudo mkdir -p /opt/neustream
            sudo chown ${{ secrets.MEDIA_SERVER_USERNAME }}:${{ secrets.MEDIA_SERVER_USERNAME }} /opt/neustream
            cd /opt/neustream

            # Install required dependencies
            echo "Installing dependencies..."
            sudo wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/bin/yq && sudo chmod +x /usr/bin/yq
            sudo apt-get update && sudo apt-get install -y jq

            # Install mediamtx
            echo "Installing mediamtx..."
            wget https://github.com/bluenviron/mediamtx/releases/download/v1.8.0/mediamtx_v1.8.0_linux_amd64.tar.gz
            tar -xvf mediamtx_v1.8.0_linux_amd64.tar.gz
            sudo mv mediamtx /usr/local/bin/
            sudo cp /opt/neustream/mediamtx.yml /etc/mediamtx.yml

            # Create environment file for media server
            cat > .env << EOF
            NODE_ENV=production
            POSTHOG_API_KEY=${{ secrets.POSTHOG_API_KEY }}
            POSTHOG_HOST=${{ secrets.POSTHOG_HOST }}
            CONTROL_PLANE_URL=https://api.neustream.app
            EOF

            # Copy nginx configuration from project
            echo "Updating nginx configuration..."
            sudo cp /opt/neustream/nginx-media-server.conf /etc/nginx/nginx.conf
            sudo nginx -t
            sudo systemctl restart nginx
            sudo systemctl enable nginx 2>/dev/null || echo "nginx already enabled"

            # Clean up any existing processes
            echo "Cleaning up existing processes..."
            pm2 stop neustream-media-server || true
            pm2 delete neustream-media-server || true

            # Start mediamtx with proper configuration
            echo "Starting media server..."
            pm2 start /usr/local/bin/mediamtx --name neustream-media-server -- /etc/mediamtx.yml

            # Wait for service to be ready and ports to open
            echo "Waiting for MediaMTX to initialize and open ports..."
            sleep 15

            # Verify deployment success
            echo "Verifying deployment..."
            pm2 status

            # Check if media server process is running
            if pm2 describe neustream-media-server | grep -q "online"; then
              echo "‚úÖ Media Server process is running"
            else
              echo "‚ùå Media Server process failed to start"
              pm2 logs neustream-media-server --lines 30
              exit 1
            fi

            # Check if ports are accessible using curl/fallback methods
            echo "Testing port accessibility..."

            # Test API port first (most reliable)
            if curl -f http://localhost:9997/v3/config/global/get > /dev/null 2>&1; then
              echo "‚úÖ API port 9997 is accessible"
            else
              echo "‚ùå API port 9997 is not accessible"
              pm2 logs neustream-media-server --lines 10
              exit 1
            fi

            # Test RTMP port by attempting a connection check
            # Use timeout to avoid hanging
            if timeout 3 bash -c "</dev/tcp/localhost/1935" 2>/dev/null; then
              echo "‚úÖ RTMP port 1935 is accessible"
            else
              echo "‚ö†Ô∏è  RTMP port 1935 test failed (this may be normal - checking with alternative method)"
              # Fallback: check if process logs show RTMP listener is ready
              if pm2 logs neustream-media-server --lines 20 | grep -q "RTMP.*listener opened on :1935"; then
                echo "‚úÖ RTMP port 1935 is confirmed in logs"
              else
                echo "‚ùå RTMP port 1935 verification failed"
                pm2 logs neustream-media-server --lines 20
                exit 1
              fi
            fi

            echo "‚úÖ All ports are accessible and MediaMTX API is responding"

            # Test updated stream scripts
            echo "üß™ Testing updated stream handling scripts..."

            # Test if enhanced stream scripts exist and are executable
            if [ -f /opt/neustream/on_stream_ready.sh ]; then
              if [ -x /opt/neustream/on_stream_ready.sh ]; then
                echo "‚úÖ Stream ready script is executable"
              else
                echo "‚ö†Ô∏è Stream ready script exists but not executable - fixing permissions..."
                chmod +x /opt/neustream/on_stream_ready.sh
              fi
            else
              echo "‚ùå Stream ready script not found"
              exit 1
            fi

            if [ -f /opt/neustream/on_stream_unpublish.sh ]; then
              if [ -x /opt/neustream/on_stream_unpublish.sh ]; then
                echo "‚úÖ Stream unpublish script is executable"
              else
                echo "‚ö†Ô∏è Stream unpublish script exists but not executable - fixing permissions..."
                chmod +x /opt/neustream/on_stream_unpublish.sh
              fi
            else
              echo "‚ùå Stream unpublish script not found"
              exit 1
            fi

            # Test jq availability (used by updated scripts)
            if command -v jq >/dev/null 2>&1; then
              echo "‚úÖ jq is available for JSON parsing"
            else
              echo "‚ùå jq is not available - stream scripts may fail"
              exit 1
            fi

            echo "üéØ Media server script verification completed"
            echo "‚úÖ Media Server deployment with multi-source support verified successfully!"
            echo "üì∫ RTMP Streaming URL: rtmp://stream.neustream.app/live"

  deploy-frontend:
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: |
          cd frontend
          npm ci

      - name: Build frontend
        run: |
          cd frontend
          echo "VITE_API_BASE=https://api.neustream.app/api" > .env.production
          echo "VITE_PUBLIC_POSTHOG_KEY=${{ secrets.VITE_PUBLIC_POSTHOG_KEY }}" >> .env.production
          echo "VITE_PUBLIC_POSTHOG_HOST=${{ secrets.VITE_PUBLIC_POSTHOG_HOST }}" >> .env.production
          npm run build

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy dist --project-name=neustream-frontend
          workingDirectory: frontend

  deploy-admin:
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: |
          cd admin
          npm ci

      - name: Build admin
        run: |
          cd admin
          echo "VITE_API_URL=https://api.neustream.app" > .env.production
          echo "VITE_NODE_ENV=production" >> .env.production
          npm run build

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy dist --project-name=neustream-admin
          workingDirectory: admin
