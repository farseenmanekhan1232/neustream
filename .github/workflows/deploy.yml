name: Deploy Neustream (Initial Setup)

on:
  workflow_dispatch:  # Manual trigger only

jobs:
  setup-control-plane:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Control Plane
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.CONTROL_PLANE_HOST }}
        username: ${{ secrets.CONTROL_PLANE_USERNAME }}
        key: ${{ secrets.CONTROL_PLANE_SSH_KEY }}
        script: |
          echo "ðŸš€ Running minimal Control Plane setup..."

          # Download and run minimal setup script
          curl -O https://raw.githubusercontent.com/farseenmanekhan1232/neustream/main/setup-control-plane-minimal.sh
          chmod +x setup-control-plane-minimal.sh
          ./setup-control-plane-minimal.sh

          echo "âœ… Control Plane setup complete!"

  setup-media-server:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Media Server
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.MEDIA_SERVER_HOST }}
        username: ${{ secrets.MEDIA_SERVER_USERNAME }}
        key: ${{ secrets.MEDIA_SERVER_SSH_KEY }}
        script: |
          echo "ðŸš€ Running minimal Media Server setup..."

          # Download and run minimal setup script
          curl -O https://raw.githubusercontent.com/farseenmanekhan1232/neustream/main/setup-media-server-minimal.sh
          chmod +x setup-media-server-minimal.sh
          ./setup-media-server-minimal.sh

          echo "âœ… Media Server setup complete!"

  deploy-frontend:
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request'
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install Vercel CLI
      run: npm install -g vercel

    - name: Deploy to Vercel
      run: |
        if [ -n "${{ secrets.VERCEL_TOKEN }}" ]; then
          cd frontend
          echo "VITE_API_BASE=http://${{ secrets.CONTROL_PLANE_HOST }}:3000/api" > .env.production
          vercel --prod --token ${{ secrets.VERCEL_TOKEN }} --confirm
        else
          echo "Skipping Vercel deployment - VERCEL_TOKEN not set"
        fi