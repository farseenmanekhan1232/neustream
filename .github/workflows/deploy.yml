name: Deploy Neustream (Initial Setup)

on:
  workflow_dispatch: # Manual trigger only

jobs:
  setup-control-plane:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Copy code to Control Plane
        uses: appleboy/scp-action@v0.1.3
        with:
          host: ${{ secrets.CONTROL_PLANE_HOST }}
          username: ${{ secrets.CONTROL_PLANE_USERNAME }}
          key: ${{ secrets.CONTROL_PLANE_SSH_KEY }}
          source: "."
          target: "/opt/neustream"

      - name: Setup Control Plane
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.CONTROL_PLANE_HOST }}
          username: ${{ secrets.CONTROL_PLANE_USERNAME }}
          key: ${{ secrets.CONTROL_PLANE_SSH_KEY }}
          script: |
            echo "ðŸš€ Running complete Control Plane setup..."

            # Update package list
            sudo apt update

            # Install git (skip if already installed)
            sudo apt install -y git || echo "Git already installed"

            # Enable IPv6 for database connectivity
            echo 'net.ipv6.conf.all.disable_ipv6 = 0' | sudo tee -a /etc/sysctl.conf
            echo 'net.ipv6.conf.default.disable_ipv6 = 0' | sudo tee -a /etc/sysctl.conf
            sudo sysctl -p

            # Install and configure local PostgreSQL database
            echo "ðŸš€ Setting up local PostgreSQL database..."
            sudo apt install -y postgresql postgresql-contrib

            # Start PostgreSQL service
            sudo systemctl start postgresql
            sudo systemctl enable postgresql

            # Drop existing database and user (if they exist) and create fresh ones
            sudo -u postgres psql -c "DROP DATABASE IF EXISTS neustream;"
            sudo -u postgres psql -c "DROP USER IF EXISTS neustream_user;"
            sudo -u postgres psql -c "CREATE DATABASE neustream;"
            sudo -u postgres psql -c "CREATE USER neustream_user WITH PASSWORD '23k4j123k4ksdhfasiuhe';"
            sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE neustream TO neustream_user;"

            # Allow local connections
            echo "host    neustream     neustream_user     127.0.0.1/32            md5" | sudo tee -a /etc/postgresql/*/main/pg_hba.conf

            # Restart PostgreSQL to apply changes
            sudo systemctl restart postgresql

            echo "âœ… Local PostgreSQL database installed and configured"

            # Install Node.js 18 (skip if already installed)
            if ! command -v node &> /dev/null; then
              curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
              sudo apt install -y nodejs
            else
              echo "Node.js already installed"
            fi

            # Install PM2 (skip if already installed)
            sudo npm install -g pm2 || echo "PM2 already installed"

            # No Cloudflare Tunnel needed - using Hostinger domain with SSL

            # Install nginx for HTTPS reverse proxy
            sudo apt install -y nginx

            # Open firewall ports for HTTP/HTTPS (Oracle Cloud)
            sudo iptables -A INPUT -p tcp --dport 80 -j ACCEPT 2>/dev/null || echo "Port 80 rule already exists"
            sudo iptables -A INPUT -p tcp --dport 443 -j ACCEPT 2>/dev/null || echo "Port 443 rule already exists"

            # Create app directory and set ownership (idempotent)
            sudo mkdir -p /opt/neustream
            sudo chown ${{ secrets.CONTROL_PLANE_USERNAME }}:${{ secrets.CONTROL_PLANE_USERNAME }} /opt/neustream
            cd /opt/neustream

            # Install dependencies
            npm install --no-audit --no-fund

            # Create environment file with local PostgreSQL configuration
            cat > .env << EOF
            DB_HOST=localhost
            DB_PORT=5432
            DB_NAME=neustream
            DB_USER=neustream_user
            DB_PASSWORD=23k4j123k4ksdhfasiuhe
            PORT=3000
            NODE_ENV=production
            MEDIA_SERVER_HOST=${{ secrets.MEDIA_SERVER_HOST }}
            STREAM_DOMAIN=${{ secrets.STREAM_DOMAIN }}
            JWT_SECRET=$(openssl rand -base64 32)
            EOF

            # Setup nginx reverse proxy with SSL
            cat > /tmp/nginx-control-plane.conf << 'EOF'
            server {
                listen 80;
                server_name api.neustream.app;
                return 301 https://$server_name$request_uri;
            }

            server {
                listen 443 ssl;
                server_name api.neustream.app;

                ssl_certificate /etc/letsencrypt/live/neustream.app/fullchain.pem;
                ssl_certificate_key /etc/letsencrypt/live/neustream.app/privkey.pem;

                location / {
                    proxy_pass http://localhost:3000;
                    proxy_http_version 1.1;
                    proxy_set_header Upgrade $http_upgrade;
                    proxy_set_header Connection 'upgrade';
                    proxy_set_header Host $host;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto $scheme;
                    proxy_cache_bypass $http_upgrade;
                }
            }
            EOF

            sudo cp /tmp/nginx-control-plane.conf /etc/nginx/sites-available/neustream
            sudo ln -sf /etc/nginx/sites-available/neustream /etc/nginx/sites-enabled/
            sudo rm -f /etc/nginx/sites-enabled/default
            sudo nginx -t
            sudo systemctl restart nginx

            # Run database migrations with local PostgreSQL
            echo "Running database migrations..."
            npm run migrate || echo "Migrations failed - please check PostgreSQL logs"

            # Stop existing service if running
            pm2 delete neustream-control-plane 2>/dev/null || echo "No existing service to delete"

            # Clean up any orphaned processes
            pkill -f "node.*server.js" 2>/dev/null || echo "No orphaned processes found"

            # Start service with PM2
            pm2 start server.js --name "neustream-control-plane"
            pm2 save

            # Setup PM2 startup (idempotent)
            sudo env PATH=$PATH:/usr/bin /usr/lib/node_modules/pm2/bin/pm2 startup systemd -u ${{ secrets.CONTROL_PLANE_USERNAME }} --hp /home/${{ secrets.CONTROL_PLANE_USERNAME }} 2>/dev/null || echo "PM2 startup already configured"

            # Verify service is running
            sleep 5
            pm2 status
            curl -f http://localhost:3000/health || echo "Health check failed but continuing..."

            echo "âœ… Control Plane setup complete!"

  setup-media-server:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Copy code to Media Server
        uses: appleboy/scp-action@v0.1.3
        with:
          host: ${{ secrets.MEDIA_SERVER_HOST }}
          username: ${{ secrets.MEDIA_SERVER_USERNAME }}
          key: ${{ secrets.MEDIA_SERVER_SSH_KEY }}
          source: "."
          target: "/opt/neustream"

      - name: Setup Media Server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.MEDIA_SERVER_HOST }}
          username: ${{ secrets.MEDIA_SERVER_USERNAME }}
          key: ${{ secrets.MEDIA_SERVER_SSH_KEY }}
          script: |
            echo "ðŸš€ Running complete Media Server setup..."

            # Update package list
            sudo apt update

            # Install git (skip if already installed)
            sudo apt install -y git || echo "Git already installed"

            # Install nginx with RTMP module (skip if already installed)
            sudo apt install -y nginx libnginx-mod-rtmp || echo "nginx already installed"

            # No Cloudflare Tunnel needed for media server

            # Configure firewall (use iptables instead of ufw)
            sudo iptables -A INPUT -p tcp --dport 1935 -j ACCEPT 2>/dev/null || echo "Firewall rule already exists"
            sudo iptables -A INPUT -p tcp --dport 80 -j ACCEPT 2>/dev/null || echo "Firewall rule already exists"

            # Create app directory and set ownership (idempotent)
            sudo mkdir -p /opt/neustream
            sudo chown ${{ secrets.MEDIA_SERVER_USERNAME }}:${{ secrets.MEDIA_SERVER_USERNAME }} /opt/neustream
            cd /opt/neustream

            # Create main nginx config with RTMP module loaded at top level
            cat > /tmp/nginx-main.conf << 'EOF'
            # Load RTMP module
            load_module /usr/lib/nginx/modules/ngx_rtmp_module.so;

            worker_processes auto;
            error_log /var/log/nginx/error.log warn;
            pid /var/run/nginx.pid;

            events {
                worker_connections 1024;
            }

            # RTMP configuration
            rtmp {
                server {
                    listen 1935;
                    chunk_size 4096;
                    max_streams 10;
                    ping 30s;
                    ping_timeout 10s;

                    application live {
                        live on;
                        record off;
                        drop_idle_publisher 10s;

                        # Authentication callback (must use HTTP, not HTTPS for RTMP)
                        on_publish http://api.neustream.app/api/auth/stream;
                        on_publish_done http://api.neustream.app/api/auth/stream-end;

                        # Push to destinations based on user configuration
                        # This will be dynamically updated by the control plane
                        # For now, we'll use static destinations that users configure
                        # push rtmp://a.rtmp.youtube.com/live2/stream_key_here;
                        # push rtmp://live.twitch.tv/app/stream_key_here;
                        # push rtmp://live-api-s.facebook.com:80/rtmp/stream_key_here;
                    }
                }
            }

            # HTTP server for stats and health checks
            http {
                # HTTP redirect to HTTPS
                server {
                    listen 80;
                    server_name stream.neustream.app;
                    return 301 https://$server_name$request_uri;
                }

                # HTTPS server
                server {
                    listen 443 ssl;
                    server_name stream.neustream.app;

                    ssl_certificate /etc/letsencrypt/live/stream.neustream.app/fullchain.pem;
                    ssl_certificate_key /etc/letsencrypt/live/stream.neustream.app/privkey.pem;

                    # Stats page
                    location /stat {
                        rtmp_stat all;
                        rtmp_stat_stylesheet stat.xsl;
                    }

                    location /stat.xsl {
                        root /usr/share/nginx/html;
                    }

                    location /health {
                        return 200 'ok';
                        add_header Content-Type text/plain;
                    }
                }
            }
            EOF

            sudo cp /tmp/nginx-main.conf /etc/nginx/nginx.conf
            sudo nginx -t
            sudo systemctl restart nginx
            sudo systemctl enable nginx 2>/dev/null || echo "nginx already enabled"

            # Verify nginx is running
            sleep 3
            curl -f http://localhost/health || echo "nginx health check failed but continuing..."

            echo "âœ… Media Server setup complete!"
            echo "ðŸ“º RTMP Streaming URL: rtmp://stream.neustream.app/live"

  deploy-frontend:
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install Vercel CLI
        run: npm install -g vercel

      - name: Deploy to Vercel
        run: |
          if [ -n "${{ secrets.VERCEL_TOKEN }}" ]; then
            cd frontend
            # Use your domain with HTTPS for API access
            echo "VITE_API_BASE=https://api.neustream.app/api" > .env.production
            vercel --prod --token ${{ secrets.VERCEL_TOKEN }} --confirm
          else
            echo "Skipping Vercel deployment - VERCEL_TOKEN not set"
          fi